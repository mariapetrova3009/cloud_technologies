# Отчёт Лаба 2

## Bad practices в плохом файле

1. **image: nginx:latest**  
   Не использование фиксированной версии. Так как на локальной машине работает одна версия, а при сборке проекта подтянется самая свежая, то поведение контейнера может отличаться + появятся баги.  

2. **container_name: web**  
   Может сломать масштабирование, так как нет возможности поднять несколько копий сервиса. Может возникнуть конфликт контейнеров.  

3. **user: root**  
   Небезопасно. Это полный доступ внутри контейнера, при уязвимости злоумышленник может получить доступ и к хосту.  

4. **privileged: true**  
   Дает контейнеру полный доступ к устройствам и возможность управлять сетью — это снижает безопасность.  

5. **network_mode: host**  
   Контейнер получает сеть хоста (нет изоляции, все сервисы слушают один порт).  

6. **volumes: - ./:/usr/share/nginx/html**  
   Папка внутри контейнера, где nginx ищет статические файлы.  
   В результате весь проект прокидывается внутрь контейнера. Это небезопасно, и появляются ненужные файлы в контейнере.  

7. **environment: REDIS_PASSWORD=supersecret**  
   Пароль прямо в compose-файле, и он неизменяем (нужно менять сам compose). Любой, у кого есть доступ к машине, может узнать пароль.  

8. **cache: ports: - "6379:6379"**  
   Redis становится доступен «наружу». Всё, что приходит на localhost:6379, будет напрямую попадать в Redis внутри контейнера.  

9. **restart: always**  
   Контейнер может падать с ошибкой, но Docker будет бесконечно его перезапускать. Из-за этого можно даже не заметить проблему, а нагрузка на систему будет расти.  

---

## Исправления в хорошем файле и результат

1. Было **nginx:latest** → стало **nginx:1.25-alpine** и **redis:7.2-alpine**.  
   Фиксированные версии, проект будет вести себя одинаково на разных машинах.  

2. Убираем **container_name**. Docker сам присваивает уникальные имена.  
   Благодаря этому можно запускать несколько копий сервиса без конфликтов.  

3. Мы убрали **user: root**. Nginx и Redis по умолчанию работают от своих системных пользователей.  
   Это безопаснее и снижает риск, что кто-то через контейнер получит root-доступ к хосту.  

4. Без **privileged** и **host-сети**.  
   В новом варианте нет `privileged: true` и `network_mode: host`. Сервисы работают с изоляцией.  
   Это значит, что они не идут напрямую в сеть хоста, и мы сами управляем, какие порты открывать наружу.  

5. Не указываем пароли в файле.  
   Раньше пароль Redis был прямо в `environment`. В хорошем варианте мы его убрали, и написали, что нужно использовать `.env` или `secrets`.  

6. Публикуем только нужные.  
   Redis больше не проброшен наружу (`6379:6379` убрали). Доступ к нему есть только у контейнеров внутри сети.  
   Наружу публикуется только nginx (`8080:80`), потому что именно веб-сервер нужен пользователям.  

7. **Volumes** только нужные.  
   Раньше мы монтировали весь проект внутрь. Теперь монтируем только статические файлы и конфиг nginx.  
   Это аккуратнее и безопаснее: внутрь попадает только то, что действительно нужно.  

8. Без бесконечных рестартов.  
   `restart: always` убрали. Если контейнер упадёт, мы сразу увидим ошибку.  

---

## Итог

После исправлений проект стал:  

- **предсказуемый** (фиксированные версии образов);  
- **безопасный** (нет root, privileged, network_mode: host, открытых портов и паролей в коде);  
- **удобный для отладки** (если что-то падает — видно сразу).  

---

## Как мы добились изоляции?

В файле `docker-compose-goodfix.yaml` сделано так, чтобы web и cache поднимались вместе, но при этом не «видели» друг друга по сети.  

1. Для каждого сервиса сделана своя сеть:  
   - web подключён к сети **web-net**;  
   - cache подключён к сети **cache-net**.  

2. У сети `cache-net` указан флаг `internal: true`. Из этой сети вообще нет выхода наружу. Redis остаётся полностью закрытым: к нему нельзя подключиться ни снаружи, ни из web.  

![photo_5332520889956300274_y](https://github.com/user-attachments/assets/a73a3d89-63f5-4e10-a868-cd90235e374c)
![photo_5332520889956300280_y](https://github.com/user-attachments/assets/2d96b231-2310-40b2-9504-f1dee8145831)
![photo_5332520889956300283_y](https://github.com/user-attachments/assets/f7f76c54-8dc2-485b-843c-4bdfcb3bd0b1)



**Итог:**  
- Контейнеры поднимаются вместе, но они изолированы друг от друга.  
- Веб-сервер доступен только снаружи через `localhost:8080`.  
- Redis скрыт — никакой другой контейнер в проекте не может к нему подключиться.  
- Контейнеры внутри одной сети могут общаться друг с другом, а контейнеры в разных сетях — нет.  
